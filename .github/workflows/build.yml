name: build

on:
  push:
    branches: ["**"]
    tags: ["v*"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  linux-amd64:
    name: linux (amd64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Compute artifact tag
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "ARTIFACT_TAG=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"
          else
            echo "ARTIFACT_TAG=sha-${GITHUB_SHA::7}" >> "$GITHUB_ENV"
          fi

      - name: Install deps (GDAL + curl + libarchive)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build pkg-config g++ \
            libgdal-dev libcurl4-openssl-dev libarchive-dev

      - name: Configure (release)
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build -j

      - name: Package
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist
          cp -f build/dist2land dist/
          cp -f README.md dist/ || true
          cp -f LICENSE dist/ || true
          tar -czf dist2land-${{ env.ARTIFACT_TAG }}-linux-amd64.tar.gz -C dist .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-amd64
          path: dist2land-${{ env.ARTIFACT_TAG }}-linux-amd64.tar.gz

  linux-arm64:
    name: linux (arm64)
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Compute artifact tag
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "ARTIFACT_TAG=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"
          else
            echo "ARTIFACT_TAG=sha-${GITHUB_SHA::7}" >> "$GITHUB_ENV"
          fi

      - name: Install deps (GDAL + curl + libarchive)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build pkg-config g++ \
            libgdal-dev libcurl4-openssl-dev libarchive-dev

      - name: Configure (release)
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build -j

      - name: Package
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist
          cp -f build/dist2land dist/
          cp -f README.md dist/ || true
          cp -f LICENSE dist/ || true
          tar -czf dist2land-${{ env.ARTIFACT_TAG }}-linux-arm64.tar.gz -C dist .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64
          path: dist2land-${{ env.ARTIFACT_TAG }}-linux-arm64.tar.gz

  windows-x64:
    name: windows (x64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up MSYS2 (MINGW64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-gdal
            mingw-w64-x86_64-curl
            mingw-w64-x86_64-libarchive
            mingw-w64-x86_64-proj
            mingw-w64-x86_64-geos
            unzip
            p7zip
            git

      - name: Compute artifact tag
        shell: msys2 {0}
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "ARTIFACT_TAG=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"
          else
            echo "ARTIFACT_TAG=sha-${GITHUB_SHA::7}" >> "$GITHUB_ENV"
          fi

      - name: Configure (release)
        shell: msys2 {0}
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        shell: msys2 {0}
        run: |
          cmake --build build -j

      - name: Package portable zip (includes run.bat)
        shell: msys2 {0}
        run: |
          set -euo pipefail
          rm -rf dist dist2land-${{ env.ARTIFACT_TAG }}-windows-x64.zip
          mkdir -p dist

          cp -f build/dist2land.exe dist/dist2land.exe
          cp -f build/dist2land_gdal.dll dist/dist2land_gdal.dll
          cp -f README.md dist/ || true
          cp -f LICENSE dist/ || true

          # Copy dependent DLLs for the exe (MinGW runtime + GDAL/PROJ/GEOS/CURL/etc)
          copy_deps () {
            local bin="$1"
            [ -f "$bin" ] || return 0
            ldd "$bin" | awk '{print $3}' | grep -E "^/mingw64/bin/.*\.dll$" | sort -u | while read -r d; do
              [ -f "$d" ] && cp -f "$d" dist/
            done
          }
          copy_deps build/dist2land.exe

          # PROJ data (needed for CRS transforms, e.g., AEQD)
          mkdir -p dist/share/proj
          cp -r /mingw64/share/proj/* dist/share/proj/ || true

          # GDAL data (sometimes needed depending on drivers/config)
          mkdir -p dist/share/gdal
          cp -r /mingw64/share/gdal/* dist/share/gdal/ || true

          cat > dist/dist2land.bat <<'EOF'
          @echo off
          setlocal
          set "DIR=%~dp0"
          
          rem Ensure we load DLLs from this folder first.
          set "PATH=%DIR%;%SystemRoot%\System32;%SystemRoot%"
          
          rem Writable per-user storage (datasets downloaded by `setup`)
          set "APPBASE=%LOCALAPPDATA%\dist2land"
          set "HOME=%APPBASE%"
          set "XDG_CACHE_HOME=%APPBASE%\cache"
          
          rem Bundle data directories for PROJ/GDAL (must be set before GDAL loads)
          set "PROJ_LIB=%DIR%share\proj"
          set "GDAL_DATA=%DIR%share\gdal"
          
          "%DIR%dist2land.exe" %*
          endlocal
          EOF

          7z a dist2land-${{ env.ARTIFACT_TAG }}-windows-x64.zip ./dist/*

      - name: Smoke test (Windows)
        shell: msys2 {0}
        run: |
          cd dist
          cmd //c dist2land.bat help
          cmd //c dist2land.bat providers

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: dist2land-${{ env.ARTIFACT_TAG }}-windows-x64.zip

  publish:
    name: publish to GitHub Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [linux-amd64, linux-arm64, windows-x64]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Publish
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-assets/linux-amd64/*.tar.gz
            release-assets/linux-arm64/*.tar.gz
            release-assets/windows-x64/*.zip
